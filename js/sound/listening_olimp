// ------------------------------
// AI Bayan Listening Olympiad 2025 — Level A2
// ------------------------------

let currentListen = 0;
let listenScore = 0;
const listeningData = [
  {
    title: "1. In the Café",
    audio: "https://www.eslfast.com/robot/topics/eating/eating01.mp3",
    questions: [
      { q: "Where are the people talking?", opts: ["At school", "In a café", "At home"], a: 1 },
      { q: "What do they order?", opts: ["Tea", "Coffee", "Juice"], a: 1 },
      { q: "How is the café described?", opts: ["Noisy", "Quiet", "Busy"], a: 2 }
    ]
  },
  {
    title: "2. At the Airport",
    audio: "https://listenaminute.com/a/airport.mp3",
    questions: [
      { q: "Where is the speaker?", opts: ["At a station", "At an airport", "At school"], a: 1 },
      { q: "What does he need?", opts: ["Passport", "Ticket", "Luggage"], a: 2 },
      { q: "How does he feel?", opts: ["Excited", "Angry", "Tired"], a: 0 }
    ]
  },
  {
    title: "3. A Weekend Trip",
    audio: "https://listenaminute.com/w/weekend.mp3",
    questions: [
      { q: "Where did the person go?", opts: ["To the mountains", "To the city", "To the beach"], a: 2 },
      { q: "Who did they go with?", opts: ["Alone", "With family", "With friends"], a: 2 },
      { q: "How was the weather?", opts: ["Sunny", "Rainy", "Windy"], a: 0 }
    ]
  },
  {
    title: "4. Talking about School",
    audio: "https://learnenglishteens.britishcouncil.org/sites/teens/files/listening-school.mp3",
    questions: [
      { q: "What subject does she like?", opts: ["Math", "English", "PE"], a: 1 },
      { q: "Who is her favourite teacher?", opts: ["Mr. Brown", "Mrs. Lee", "Miss Carter"], a: 2 },
      { q: "What time does school finish?", opts: ["2 p.m.", "3 p.m.", "4 p.m."], a: 1 }
    ]
  },
  {
    title: "5. Weather Forecast",
    audio: "https://listenaminute.com/w/weather.mp3",
    questions: [
      { q: "What season is it?", opts: ["Winter", "Spring", "Summer"], a: 2 },
      { q: "What is the weather like?", opts: ["Cold", "Hot", "Rainy"], a: 1 },
      { q: "What should people wear?", opts: ["Coats", "T-shirts", "Jackets"], a: 1 }
    ]
  },
  {
    title: "6. Shopping for Clothes",
    audio: "https://www.eslfast.com/robot/topics/shopping/shopping01.mp3",
    questions: [
      { q: "Where is the conversation?", opts: ["In a shop", "At home", "At the bank"], a: 0 },
      { q: "What are they buying?", opts: ["Shoes", "T-shirts", "Jackets"], a: 2 },
      { q: "What size does she need?", opts: ["Small", "Medium", "Large"], a: 1 }
    ]
  },
  {
    title: "7. At the Doctor’s",
    audio: "https://learnenglish.britishcouncil.org/sites/podcasts/files/health.mp3",
    questions: [
      { q: "Why does the person visit the doctor?", opts: ["Headache", "Cold", "Back pain"], a: 0 },
      { q: "What medicine is recommended?", opts: ["Aspirin", "Vitamins", "Tea"], a: 0 },
      { q: "When should they rest?", opts: ["Today", "Tomorrow", "Weekend"], a: 0 }
    ]
  },
  {
    title: "8. A Phone Conversation",
    audio: "https://www.esl-lab.com/wp-content/uploads/2021/01/phone-conversation.mp3",
    questions: [
      { q: "Who is calling?", opts: ["Mother", "Friend", "Teacher"], a: 1 },
      { q: "What are they talking about?", opts: ["Homework", "Plans", "Food"], a: 1 },
      { q: "When will they meet?", opts: ["Today", "Tomorrow", "Next week"], a: 1 }
    ]
  },
  {
    title: "9. Weekend Plans",
    audio: "https://www.eslfast.com/robot/topics/weekend/weekend01.mp3",
    questions: [
      { q: "What does he want to do?", opts: ["Stay home", "Go hiking", "Visit friends"], a: 2 },
      { q: "What day is the plan for?", opts: ["Saturday", "Sunday", "Friday"], a: 0 },
      { q: "Who will join him?", opts: ["Parents", "Sister", "Friends"], a: 2 }
    ]
  },
  {
    title: "10. A Birthday Party",
    audio: "https://listenaminute.com/b/birthday.mp3",
    questions: [
      { q: "Whose birthday is it?", opts: ["Emma's", "Tom's", "Sara's"], a: 1 },
      { q: "Where is the party?", opts: ["At home", "At school", "In a restaurant"], a: 0 },
      { q: "What are they eating?", opts: ["Cake", "Pizza", "Sandwiches"], a: 0 }
    ]
  }
];

// ------------------------------
// Render Listening Question
// ------------------------------
function showListening() {
  const q = listeningData[currentListen];
  const container = document.getElementById("listeningContent");
  container.innerHTML = `
    <h3>${q.title}</h3>
    <audio controls>
      <source src="${q.audio}" type="audio/mpeg">
    </audio><br>
    ${q.questions.map(
      (item, i) =>
        `<p>${item.q}</p>${item.opts
          .map(
            (opt, j) =>
              `<button class='optBtn' data-opt='${j}'>${opt}</button>`
          )
          .join("<br>")}`
    ).join("<hr>")}
  `;
  document.querySelectorAll(".optBtn").forEach((btn) =>
    btn.addEventListener("click", () => checkListening(parseInt(btn.dataset.opt)))
  );
}

// ------------------------------
// Check Answer
// ------------------------------
function checkListening(choice) {
  const q = listeningData[currentListen];
  const correctAnswers = q.questions.map(x => x.a);
  if (correctAnswers.includes(choice)) {
    listenScore++;
    playStar();
    new Audio("sound/ding.wav").play();
  } else {
    new Audio("sound/error.wav").play();
  }
  currentListen++;
  if (currentListen < listeningData.length) {
    showListening();
  } else {
    document.getElementById("listeningContent").innerHTML = `
      <h3>🎉 Well done! You finished the Listening Olympiad!</h3>
      <p>Your score: ${listenScore} / ${listeningData.length * 3}</p>
    `;
  }
}

// ------------------------------
// Star Animation
// ------------------------------
function playStar() {
  const star = document.createElement("div");
  star.textContent = "⭐";
  star.style.position = "absolute";
  star.style.left = "50%";
  star.style.top = "50%";
  star.style.fontSize = "40px";
  star.style.animation = "fly 1s ease-out";
  document.body.appendChild(star);
  setTimeout(() => star.remove(), 1000);
}

// ------------------------------
// Listening Olimp Screen
// ------------------------------
document.body.insertAdjacentHTML(
  "beforeend",
  `
  <div id='listeningOlimp' class='screen section'>
    <h2>🎧 Listening Olympiad — A2</h2>
    <div id='listeningContent'></div>
    <div class='nav-buttons'>
      <button id='lBack'>Back</button>
      <button id='lNext'>Next</button>
    </div>
  </div>`
);

document.getElementById("lBack").addEventListener("click", () => {
  currentListen = Math.max(0, currentListen - 1);
  showListening();
});
document.getElementById("lNext").addEventListener("click", () => {
  currentListen = Math.min(listeningData.length - 1, currentListen + 1);
  showListening();
});

// ------------------------------
// Menu Link Activation
// ------------------------------
document.querySelectorAll("#menu button[data-target]").forEach((btn) => {
  if (btn.dataset.target === "listeningOlimp") {
    btn.addEventListener("click", () => {
      currentListen = 0;
      listenScore = 0;
      show("listeningOlimp");
      showListening();
    });
  }
});
